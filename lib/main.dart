// dart
import 'dart:io';
import 'dart:core';

// flutter
import 'package:flutter/material.dart';
import 'package:flutter/foundation.dart';

// pub.dev packages
import 'package:yaml/yaml.dart';

// httapp
import 'package:httapp/ui/main_navigation.dart';
import 'package:httapp/ui/theme.dart';
// httapp models
import 'package:httapp/models/geojson_parse.dart';
import 'package:httapp/models/poi.dart';
import 'package:httapp/models/local_path.dart';
import 'package:httapp/models/remote_path.dart';
// httapp services
import 'package:httapp/services/local_file_handling.dart';
import 'package:httapp/services/firebase/remote_file_handling.dart';
import 'package:httapp/services/firebase/remote_asset_methods.dart';

// firebase api & options
import 'package:firebase_storage/firebase_storage.dart';
import 'package:firebase_core/firebase_core.dart';
import 'package:firebase_app_check/firebase_app_check.dart';
import 'firebase_options.dart';



/// Global Map from [id] to [name]
/// 
/// Used for parsing from tree_manifest.yaml
var treeIdMap = {};

/// Global Map from [id] to the Map {'id': String, 'name': String, 'body': String, 'imageFileList': List`<`File`>`, 'thmFile': File}
/// 
/// This is for the [TreeTemplatePage] constructor
Map<String, Map<String, dynamic >> treePageData = {};

List<PointOfInterest> poiData = [];

// track current downloads to prevent race conditions
final Set<String> _downloadingFiles = {};


Future<void> main() async {
  String yamlString;
  var treeIdMap = {};
  final treeManifestFile = "tree_manifest.yaml";
  final remoteTreeManifest = "text/$treeManifestFile";

  //Bind, or create, the Widget tree for the Flutter engine.
  WidgetsFlutterBinding.ensureInitialized();

  //Initialize Firebase, utilizing the firebase_options.dart file that is generated by FlutterFire CLI.
  await Firebase.initializeApp(options: DefaultFirebaseOptions.currentPlatform);

  RemoteAssets assetHandler = RemoteAssets(instance: FirebaseStorage.instance, downloadingFilesSet: _downloadingFiles);

  /*
    Activate App Check with automatic provider selection.
    If built with debug mode, FirebaseAppCheck will use the debug provider.
    Otherwise it will use the platform specific provider.
  */
  await FirebaseAppCheck.instance.activate(
    // On Android, use debug provider in debug mode, Play Integrity in release
    providerAndroid: kDebugMode
        ? AndroidDebugProvider()
        : AndroidPlayIntegrityProvider(),
    
    // On iOS, use debug provider in debug mode, App Attest in release
    providerApple: kDebugMode
      ? AppleDebugProvider()
      : AppleAppAttestProvider(),
  );

  /*
    Download and/or read the tree_manifest.yaml file as a string.
    Parse the string and return it as a YamlList.
    Append the results of the YamlList to treeIdMap, Map<dynamic, dynamic>
  */
  try {
    // read tree_manifest.yaml
    yamlString = await assetHandler.loadManifest(treeManifestFile, remoteTreeManifest);

    // read the YAML Stream
    var treeDoc = loadYamlStream(yamlString);

    // collapse the YamlList into a Map<dynamic, dynamic>
    for (var entry in treeDoc) {
      treeIdMap.addAll(entry);
    }
  }
  catch(e) {
    // TODO better error handling than this
    print("An error occured while parsing the YAML manifest!");
    print(e);
  }
  
  /*
    create treePageData entries for expected trees in the yaml manifest
  */
  try{
    // save a ListResult to reference during loop
    final imageListResult = await remoteFileHandler.listRemoteImageFiles(FirebaseStorage.instance);

    for (var id in treeIdMap.keys) {
      // retrieve the description, images, and thumbnails
      var descriptionString = await assetHandler.treeDescription(id);   // description is pulled from internet here
      File thmFile = await assetHandler.thumbnailFile(id);   // thumbnail is pulled from internet here
      List<File> imageFileList = await assetHandler.treeImgFileList(id, imageListResult);   // image is pulled from internet here
      

      print('[main][treePageData $id] imageFileList: $imageFileList');
      
      // add the matching remote data to the 
      treePageData[id] = {'id': id, 'name': treeIdMap[id], 'body': descriptionString, 'imageFileList': imageFileList, 'thmFile': thmFile};
    }
  }
  catch(e) {
    // TODO better error handling than this
    print("An error occured while building tree info pages!");
    print(e);
  }

  /*
    create POI marker list for map
  */
  String debugGeoJSON = 
  '''
{
"type": "FeatureCollection",
"name": "Featured Trees",
"features": [
{ "type": "Feature", "properties": { "id": "", "name": "European larch" }, "geometry": { "type": "Point", "coordinates": [ -72.831315, 41.945618 ] } },
{ "type": "Feature", "properties": { "id": "", "name": "Gold Rush, Dawn Redwood" }, "geometry": { "type": "Point", "coordinates": [ -72.835237, 41.946921 ] } },
{ "type": "Feature", "properties": { "id": "", "name": "Kousa dogwood" }, "geometry": { "type": "Point", "coordinates": [ -72.833615, 41.948203 ] } },
{ "type": "Feature", "properties": { "id": "", "name": "Shingle oak" }, "geometry": { "type": "Point", "coordinates": [ -72.831883, 41.947872 ] } },
{ "type": "Feature", "properties": { "id": "", "name": "Red horsechestnut" }, "geometry": { "type": "Point", "coordinates": [ -72.831928, 41.945494 ] } },
{ "type": "Feature", "properties": { "id": "", "name": "Kentucky coffeetree" }, "geometry": { "type": "Point", "coordinates": [ -72.83226, 41.947572 ] } },
{ "type": "Feature", "properties": { "id": "", "name": "Golden Larch" }, "geometry": { "type": "Point", "coordinates": [ -72.831601, 41.945724 ] } },
{ "type": "Feature", "properties": { "id": "", "name": "White oak" }, "geometry": { "type": "Point", "coordinates": [ -72.832888, 41.947738 ] } },
{ "type": "Feature", "properties": { "id": "", "name": "Sour wood" }, "geometry": { "type": "Point", "coordinates": [ -72.833549, 41.948413 ] } },
{ "type": "Feature", "properties": { "id": "", "name": "Bald Cypress" }, "geometry": { "type": "Point", "coordinates": [ -72.833652, 41.948499 ] } },
{ "type": "Feature", "properties": { "id": "", "name": "Japanese tree lilac" }, "geometry": { "type": "Point", "coordinates": [ -72.834196, 41.947407 ] } },
{ "type": "Feature", "properties": { "id": "", "name": "Chestnut Oak" }, "geometry": { "type": "Point", "coordinates": [ -72.831846, 41.947944 ] } },
{ "type": "Feature", "properties": { "id": "", "name": "Donald Wyman Crabapple" }, "geometry": { "type": "Point", "coordinates": [ -72.832617, 41.947894 ] } },
{ "type": "Feature", "properties": { "id": "", "name": "Tulip tree" }, "geometry": { "type": "Point", "coordinates": [ -72.829837, 41.944002 ] } },
{ "type": "Feature", "properties": { "id": "", "name": "Swamp white oak" }, "geometry": { "type": "Point", "coordinates": [ -72.833409, 41.948174 ] } },
{ "type": "Feature", "properties": { "id": "", "name": "Corneliancherry dogwood" }, "geometry": { "type": "Point", "coordinates": [ -72.833724, 41.947956 ] } },
{ "type": "Feature", "properties": { "id": "", "name": "Cucumber magnolia" }, "geometry": { "type": "Point", "coordinates": [ -72.831523, 41.945251 ] } },
{ "type": "Feature", "properties": { "id": "", "name": "Tamarack" }, "geometry": { "type": "Point", "coordinates": [ -72.835078, 41.946949 ] } },
{ "type": "Feature", "properties": { "id": "", "name": "Northern red Oak" }, "geometry": { "type": "Point", "coordinates": [ -72.83151, 41.948072 ] } },
{ "type": "Feature", "properties": { "id": "", "name": "Sweetgum moraine" }, "geometry": { "type": "Point", "coordinates": [ -72.832737, 41.947314 ] } },
{ "type": "Feature", "properties": { "id": "", "name": "Bur oak urban pinnacle" }, "geometry": { "type": "Point", "coordinates": [ -72.832037, 41.947965 ] } },
{ "type": "Feature", "properties": { "id": "", "name": "Japanese emperor oak" }, "geometry": { "type": "Point", "coordinates": [ -72.832356, 41.945524 ] } },
{ "type": "Feature", "properties": { "id": "", "name": "Eastern redbud" }, "geometry": { "type": "Point", "coordinates": [ -72.833653, 41.948051 ] } },
{ "type": "Feature", "properties": { "id": "", "name": "Dawn Redwood" }, "geometry": { "type": "Point", "coordinates": [ -72.83214, 41.945112 ] } },
{ "type": "Feature", "properties": { "id": "", "name": "Willow oak" }, "geometry": { "type": "Point", "coordinates": [ -72.833145, 41.946976 ] } },
{ "type": "Feature", "properties": { "id": "", "name": "Tulip tree" }, "geometry": { "type": "Point", "coordinates": [ -72.831838, 41.943946 ] } },
{ "type": "Feature", "properties": { "id": "", "name": "American chestnut" }, "geometry": { "type": "Point", "coordinates": [ -72.832224, 41.945504 ] } },
{ "type": "Feature", "properties": { "id": "", "name": "Bald cypress" }, "geometry": { "type": "Point", "coordinates": [ -72.833648, 41.949826 ] } },
{ "type": "Feature", "properties": { "id": "", "name": "Shingle oak " }, "geometry": { "type": "Point", "coordinates": [ -72.831918, 41.947936 ] } }
]
}

  ''';
  try {
    poiData = GeojsonParse.parsePointOfInterests(debugGeoJSON);
  } catch(e) {
    // TODO better error handling than this
    print("An error occured while parsing GeoJSON!");
    print(e);
  }
  
  // begin rendering the app widget, bootstrap the render tree
  runApp(const MainApp());
}

class MainApp extends StatelessWidget {
  const MainApp({super.key});

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'Holcomb Tree Trail',
      //theme: ThemeData.from(colorScheme: MaterialTheme.lightScheme(), textTheme: GoogleFonts.latoTextTheme()),
      theme: MaterialTheme().light(),
      //home: HomePage(title: 'Home Page'),
      home: const MainNavigation(), // use MainNavigation instead of HomePage
    );
  }
}