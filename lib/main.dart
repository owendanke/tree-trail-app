// dart
import 'dart:io';
import 'dart:core';

// flutter
import 'package:flutter/material.dart';
import 'package:flutter/foundation.dart';
import 'package:httapp/services/local_file_handling.dart';
import 'package:httapp/services/text_theme_manager.dart';

// pub.dev packages
import 'package:yaml/yaml.dart';
import 'package:google_fonts/google_fonts.dart';
import 'package:flutter_native_splash/flutter_native_splash.dart';

// httapp
import 'package:httapp/ui/main_navigation.dart';
import 'package:httapp/ui/theme.dart';
// httapp models
import 'package:httapp/models/geojson_parse.dart';
import 'package:httapp/models/poi.dart';
import 'package:httapp/models/local_path.dart';
// httapp services
import 'package:httapp/services/firebase/remote_file_handling.dart';
import 'package:httapp/services/firebase/remote_asset_methods.dart';
import 'package:httapp/services/version_service.dart';

// firebase api & options
import 'package:firebase_storage/firebase_storage.dart';
import 'package:firebase_core/firebase_core.dart';
import 'package:firebase_app_check/firebase_app_check.dart';
import 'firebase_options.dart';



/// Global Map from [id] to [name]
/// 
/// Used for parsing from tree_manifest.yaml
var treeIdMap = {};

/// Global Map from [id] to the Map {'id': String, 'name': String, 'body': String, 'imageFileList': List`<`File`>`, 'thmFile': File}
/// 
/// This is for the [TreeTemplatePage] constructor
Map<String, Map<String, dynamic >> treePageData = {};

/// Global list of POIs
List<PointOfInterest> poiData = [];





Future<void> main() async {
  String yamlString;
  List<File>? imageListResult;
  bool localImageList = false;
  var treeIdMap = {};
  final treeManifestFile = "tree_manifest.yaml";

  // track current downloads to prevent race conditions
  final Set<String> downloadingFiles = {};

  //Bind (create) the Widget tree for the Flutter engine.
  WidgetsBinding widgetsBinding = WidgetsFlutterBinding.ensureInitialized();

  // keep the splash screen alive until removed
  FlutterNativeSplash.preserve(widgetsBinding: widgetsBinding);

  // Initialize version service to get app version, name, package name, etc.
  VersionService().init();

  /// Initialize text theme service to manage text across the app during runtime
  TextThemeService().init(GoogleFonts.latoTextTheme());

  // Initialize Firebase, utilizing the firebase_options.dart file that is generated by FlutterFire CLI.
  await Firebase.initializeApp(options: DefaultFirebaseOptions.currentPlatform);

  // create asset handler for downloading data from server
  RemoteAssets assetHandler = RemoteAssets(instance: FirebaseStorage.instance, downloadingFilesSet: downloadingFiles);

  /*
    Activate App Check with automatic provider selection.
    If built with debug mode, FirebaseAppCheck will use the debug provider.
    Otherwise it will use the platform specific provider.
  */
  try {
    await FirebaseAppCheck.instance.activate(
      // On Android, use debug provider in debug mode, Play Integrity in release
      providerAndroid: kDebugMode
          ? AndroidDebugProvider()
          : AndroidPlayIntegrityProvider(),
      
      // On iOS, use debug provider in debug mode, App Attest in release
      providerApple: kDebugMode
        ? AppleDebugProvider()
        : AppleAppAttestProvider(),
    );
  } catch(e) {
    debugPrint('[main] Exception during Appcheck activate: $e');
    rethrow;
  }
  /*
    Download and/or read the tree_manifest.yaml file as a string.
    Parse the string and return it as a YamlList.
    Append the results of the YamlList to treeIdMap, Map<dynamic, dynamic>
  */
  try {
    // load the tree manifest file from local or remote
    yamlString = await assetHandler.loadManifest(treeManifestFile);

    // read the YAML Stream
    var treeDoc = loadYamlStream(yamlString);

    // collapse the YamlList into a Map<dynamic, dynamic>
    for (var entry in treeDoc) {
      treeIdMap.addAll(entry);
    }
  }
  catch(e) {
    // TODO better error handling than this
    print("An error occured while parsing the YAML manifest!");
    print(e);
  }
  
  /*
    create treePageData entries for expected trees in the yaml manifest
  */
  try{
    // save a ListResult to reference during loop
    ListResult resultList = await remoteFileHandler.listRemoteImageFiles(FirebaseStorage.instance);
    imageListResult = resultList.items.map((ref) => File(ref.fullPath)).toList();
    localImageList = false;
    

  } catch(e) {
    debugPrint('istRemoteImageFiles exception');
    if (imageListResult == null) {
      imageListResult = LocalFileHandler.listFiles(await localImagePath);
      localImageList = true;
    }
  }

  try {
    for (var id in treeIdMap.keys) {
      // retrieve the description, images, and thumbnails
      var descriptionString = await assetHandler.treeDescription(id);   // description is pulled from internet here

      // Load the thumbnail either from a local file or downloaded from the server
      // Stored in memory as a `Uint8List` so `Image.memory()` may be used instead of `Image.file()`.
      // Results in more memory usage, but much better performance because the app doesn't wait for slow disk read.
      Uint8List? thmFileBytes = await assetHandler.loadThumbnailFile(id);

      List<File> imageFileList = await assetHandler.treeImgFileList(id, imageListResult!, isLocal: localImageList);   // image is pulled from internet here
      

      print('[main][treePageData $id] imageFileList: $imageFileList');
      
      // add the matching remote data to the 
      treePageData[id] = {'id': id, 'name': treeIdMap[id], 'body': descriptionString, 'imageFileList': imageFileList, 'thumbnail': thmFileBytes};
    }
  }
  catch(e) {
    // TODO better error handling than this
    print("An error occured while building tree info pages!");
    print(e);
  }

  /*
    create POI marker list for map
  */
  String debugGeoJSON = 
  '''
{
"type": "FeatureCollection",
"name": "Featured Trees",
"features": [
{ "type": "Feature", "properties": { "id": "116-24", "name": "European larch" }, "geometry": { "type": "Point", "coordinates": [ -72.831315, 41.945618 ] } },
{ "type": "Feature", "properties": { "id": "123-24", "name": "dawn redwood 'Goldrush'" }, "geometry": { "type": "Point", "coordinates": [ -72.835237, 41.946921 ] } },
{ "type": "Feature", "properties": { "id": "19-19", "name": "Kousa dogwood" }, "geometry": { "type": "Point", "coordinates": [ -72.833615, 41.948203 ] } },
{ "type": "Feature", "properties": { "id": "1-18", "name": "shingle oak" }, "geometry": { "type": "Point", "coordinates": [ -72.831883, 41.947872 ] } },
{ "type": "Feature", "properties": { "id": "37-20", "name": "red horsechestnut" }, "geometry": { "type": "Point", "coordinates": [ -72.831928, 41.945494 ] } },
{ "type": "Feature", "properties": { "id": "13-18", "name": "Kentucky coffeetree" }, "geometry": { "type": "Point", "coordinates": [ -72.83226, 41.947572 ] } },
{ "type": "Feature", "properties": { "id": "111-24", "name": "golden larch" }, "geometry": { "type": "Point", "coordinates": [ -72.831601, 41.945724 ] } },
{ "type": "Feature", "properties": { "id": "46-19", "name": "white oak" }, "geometry": { "type": "Point", "coordinates": [ -72.832888, 41.947738 ] } },
{ "type": "Feature", "properties": { "id": "69-21", "name": "sourwood" }, "geometry": { "type": "Point", "coordinates": [ -72.833549, 41.948413 ] } },
{ "type": "Feature", "properties": { "id": "45-20", "name": "bald cypress" }, "geometry": { "type": "Point", "coordinates": [ -72.833652, 41.948499 ] } },
{ "type": "Feature", "properties": { "id": "26-19", "name": "Japanese tree lilac" }, "geometry": { "type": "Point", "coordinates": [ -72.834196, 41.947407 ] } },
{ "type": "Feature", "properties": { "id": "55-21", "name": "chestnut oak" }, "geometry": { "type": "Point", "coordinates": [ -72.831846, 41.947944 ] } },
{ "type": "Feature", "properties": { "id": "127-25", "name": "crabapple 'Donald Wyman'" }, "geometry": { "type": "Point", "coordinates": [ -72.832617, 41.947894 ] } },
{ "type": "Feature", "properties": { "id": "88-22", "name": "tuliptree" }, "geometry": { "type": "Point", "coordinates": [ -72.829837, 41.944002 ] } },
{ "type": "Feature", "properties": { "id": "10-18", "name": "swamp white oak" }, "geometry": { "type": "Point", "coordinates": [ -72.833409, 41.948174 ] } },
{ "type": "Feature", "properties": { "id": "20-19", "name": "corneliancherry dogwood" }, "geometry": { "type": "Point", "coordinates": [ -72.833724, 41.947956 ] } },
{ "type": "Feature", "properties": { "id": "91-23", "name": "cucumbertree magnolia" }, "geometry": { "type": "Point", "coordinates": [ -72.831523, 41.945251 ] } },
{ "type": "Feature", "properties": { "id": "102-23", "name": "tamarack" }, "geometry": { "type": "Point", "coordinates": [ -72.835078, 41.946949 ] } },
{ "type": "Feature", "properties": { "id": "54-21", "name": "northern red oak" }, "geometry": { "type": "Point", "coordinates": [ -72.83151, 41.948072 ] } },
{ "type": "Feature", "properties": { "id": "114-24", "name": "sweetgum" }, "geometry": { "type": "Point", "coordinates": [ -72.832737, 41.947314 ] } },
{ "type": "Feature", "properties": { "id": "57-21", "name": "bur oak" }, "geometry": { "type": "Point", "coordinates": [ -72.832037, 41.947965 ] } },
{ "type": "Feature", "properties": { "id": "74-21", "name": "Japanese emperor oak 'Pinnatifida'" }, "geometry": { "type": "Point", "coordinates": [ -72.832356, 41.945524 ] } },
{ "type": "Feature", "properties": { "id": "71-21", "name": "eastern redbud" }, "geometry": { "type": "Point", "coordinates": [ -72.833653, 41.948051 ] } },
{ "type": "Feature", "properties": { "id": "59-21", "name": "dawn redwood" }, "geometry": { "type": "Point", "coordinates": [ -72.83214, 41.945112 ] } },
{ "type": "Feature", "properties": { "id": "125-25", "name": "willow oak" }, "geometry": { "type": "Point", "coordinates": [ -72.833145, 41.946976 ] } },
{ "type": "Feature", "properties": { "id": "88-22", "name": "tuliptree" }, "geometry": { "type": "Point", "coordinates": [ -72.831838, 41.943946 ] } },
{ "type": "Feature", "properties": { "id": "", "name": "American chestnut" }, "geometry": { "type": "Point", "coordinates": [ -72.832224, 41.945504 ] } },
{ "type": "Feature", "properties": { "id": "45-20", "name": "bald cypress" }, "geometry": { "type": "Point", "coordinates": [ -72.833648, 41.949826 ] } },
{ "type": "Feature", "properties": { "id": "1-18", "name": "shingle oak " }, "geometry": { "type": "Point", "coordinates": [ -72.831918, 41.947936 ] } }
]
}

  ''';
  try {
    poiData = GeojsonParse.parsePointOfInterests(debugGeoJSON);
  } catch(e) {
    // TODO better error handling than this
    print("An error occured while parsing GeoJSON!");
    print(e);
  }
  
  // begin rendering the app widget, bootstrap the render tree
  runApp(const MainApp());
}

class MainApp extends StatelessWidget {
  const MainApp({super.key});

  @override
  Widget build(BuildContext context) {
    final ColorScheme colorScheme = MaterialTheme.lightScheme();
    final TextTheme textTheme = GoogleFonts.latoTextTheme();

    // remove the spash screen manually
    FlutterNativeSplash.remove();

    return MaterialApp(
      title: 'Holcomb Tree Trail',
      home: const MainNavigation(), // use MainNavigation instead of HomePage

      // create custom theme here
      theme: ThemeData(
        // use lightScheme from theme.dart
        colorScheme: colorScheme, 
        // use Lato from Google Fonts
        textTheme: textTheme,
        // app bar theme
        appBarTheme: AppBarThemeData(
          foregroundColor: colorScheme.onPrimary,
          backgroundColor: colorScheme.primary,
        ),
        // bottom navigation bar theme
        navigationBarTheme: NavigationBarThemeData(
          backgroundColor: colorScheme.primary,
          indicatorColor: colorScheme.secondary,
          labelTextStyle: WidgetStateProperty.resolveWith<TextStyle>(
              (Set<WidgetState> states) => TextStyle(color: colorScheme.onPrimary),
            ),
          iconTheme: WidgetStateProperty.resolveWith<IconThemeData>(
              (Set<WidgetState> states) => states.contains(WidgetState.selected)
              ? IconThemeData(color: colorScheme.secondaryContainer)
              : IconThemeData(color: colorScheme.onPrimary),
            ),
          ),
        // create custom button themes
        elevatedButtonTheme: ElevatedButtonThemeData(
          style: ElevatedButton.styleFrom(
            // text/icons displayed on the button (white)
            foregroundColor: colorScheme.onPrimary,
            // color of the button (green)
            backgroundColor: colorScheme.primary,
            surfaceTintColor: Colors.white,
            // make the buttons 'larger', increase density
            visualDensity: VisualDensity(vertical: 3, horizontal: 2),
            textStyle: textTheme.bodyLarge,
            elevation: 4,
          ),
        ),
        filledButtonTheme: FilledButtonThemeData(
          style: FilledButton.styleFrom(
            // text/icons displayed on the button (white)
            foregroundColor: colorScheme.onPrimary,
            // color of the button (green)
            backgroundColor: colorScheme.primary,
          )
        ),
      ),
    );
  }
}